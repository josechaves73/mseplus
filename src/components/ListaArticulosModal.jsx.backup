import React, { useState, useEffect, useRef } from 'react';
import * as XLSX from 'xlsx';
import './ListaArticulosModal.css';
import NuevoArticuloModal from './NuevoArticuloModal';
import ArticulosXBoletaModal from './ArticulosXBoletaModal';

const ListaArticulosModal = ({ isOpen, onClose }) => {
  const [articulos, setArticulos] = useState([]);
  const [filteredArticulos, setFilteredArticulos] = useState([]);
  const [unidades, setUnidades] = useState([]);
  const [familias, setFamilias] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedIndex, setSelectedIndex] = useState(0);
  const [selectedUnidad, setSelectedUnidad] = useState('');
  const [selectedFamilia, setSelectedFamilia] = useState('');
  const [showExportModal, setShowExportModal] = useState(false);
  const [showNuevoArticuloModal, setShowNuevoArticuloModal] = useState(false);
  // Estado para modo edici√≥n y datos del art√≠culo a editar
  const [editMode, setEditMode] = useState(false);
  const [articuloEditar, setArticuloEditar] = useState(null);
  // Estados para eliminaci√≥n
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [deleteStatus, setDeleteStatus] = useState(null); // null, 'checking', 'denied', 'allowed'
  const [deleteMessage, setDeleteMessage] = useState('');
  const [relatedTables, setRelatedTables] = useState([]);
  // Estado para modal de cambiar c√≥digo
  const [showCambiarCodigoModal, setShowCambiarCodigoModal] = useState(false);
  const [cambiarCodigoLoading, setCambiarCodigoLoading] = useState(false);
  const [cambiarCodigoResult, setCambiarCodigoResult] = useState(null);
  const [nuevoCodigo, setNuevoCodigo] = useState('');
  const [cambioAplicado, setCambioAplicado] = useState(false);
  const [articuloOriginal, setArticuloOriginal] = useState(null);
  // Estado para modal de trazabilidad por boleta
  const [showTrazabilidadModal, setShowTrazabilidadModal] = useState(false);
  const tableRef = useRef(null);

  useEffect(() => {
    if (isOpen) {
      fetchArticulos();
      fetchUnidades();
      fetchFamilias();
    }
  }, [isOpen]);

  useEffect(() => {
    // Validar que articulos sea un array antes de filtrar
    if (!Array.isArray(articulos)) {
      setFilteredArticulos([]);
      return;
    }

    let filtered = articulos.filter(articulo =>
      articulo?.descri?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      articulo?.codigo?.toLowerCase().includes(searchTerm.toLowerCase())
    );

    if (selectedUnidad && selectedUnidad !== '') {
      filtered = filtered.filter(articulo => {
        const articuloUnidad = String(articulo?.unidad || '').trim();
        return articuloUnidad === selectedUnidad.trim();
      });
    }

    if (selectedFamilia && selectedFamilia !== '') {
      filtered = filtered.filter(articulo => {
        const articuloFamilia = String(articulo?.familia || '').trim();
        return articuloFamilia === selectedFamilia.trim();
      });
    }

    setFilteredArticulos(filtered);
    setSelectedIndex(0);
  }, [articulos, searchTerm, selectedUnidad, selectedFamilia]);

  useEffect(() => {
    const handleKeyDown = (e) => {
      // Solo manejar teclas de navegaci√≥n si NO estamos en un input
      if (!isOpen || filteredArticulos.length === 0 || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        setSelectedIndex(prev => 
          prev < filteredArticulos.length - 1 ? prev + 1 : prev
        );
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        setSelectedIndex(prev => prev > 0 ? prev - 1 : prev);
      }
    };

    if (isOpen) {
      document.addEventListener('keydown', handleKeyDown);
    }

    return () => {
      document.removeEventListener('keydown', handleKeyDown);
    };
  }, [isOpen, filteredArticulos.length]);

  // Scroll selected row into view
  useEffect(() => {
    if (isOpen && filteredArticulos.length > 0) {
      const selectedRow = document.querySelector(`[data-index="${selectedIndex}"]`);
      if (selectedRow) {
        selectedRow.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'nearest' 
        });
      }
    }
  }, [selectedIndex, isOpen, filteredArticulos]);

  const fetchArticulos = async () => {
    setLoading(true);
    setError(null);
    try {
      const response = await fetch('http://localhost:4000/api/articulos');
      if (!response.ok) {
        throw new Error('Error al cargar art√≠culos');
      }
      const data = await response.json();
      // Validar que data.articulos sea un array
      if (Array.isArray(data.articulos)) {
        setArticulos(data.articulos);
      } else {
        console.error('Los art√≠culos recibidos no son un array:', data);
        setArticulos([]);
      }
    } catch (err) {
      setError(err.message);
      setArticulos([]);
    } finally {
      setLoading(false);
    }
  };

  const fetchUnidades = async () => {
    try {
      const response = await fetch('http://localhost:4000/api/unidades');
      if (!response.ok) {
        throw new Error('Error al cargar unidades');
      }
      const data = await response.json();
      // Los endpoints de unidades devuelven array directamente
      if (Array.isArray(data)) {
        setUnidades(data);
      } else {
        console.error('Las unidades recibidas no son un array:', data);
        setUnidades([]);
      }
    } catch (err) {
      console.error('Error fetching unidades:', err);
      setUnidades([]);
    }
  };

  const fetchFamilias = async () => {
    try {
      const response = await fetch('http://localhost:4000/api/familias');
      if (!response.ok) {
        throw new Error('Error al cargar familias');
      }
      const data = await response.json();
      // Verificar el formato de los datos de familias
      if (data.familias && Array.isArray(data.familias)) {
        setFamilias(data.familias);
      } else if (Array.isArray(data)) {
        setFamilias(data);
      } else {
        console.error('Las familias recibidas no son un array:', data);
        setFamilias([]);
      }
    } catch (err) {
      console.error('Error fetching familias:', err);
      setFamilias([]);
    }
  };

  const handleRowClick = (index) => {
    setSelectedIndex(index);
  };

  const handleExportClick = () => {
    setShowExportModal(true);
  };

  // Abrir modal de eliminaci√≥n
  const handleEliminarClick = () => {
    if (selectedIndex >= 0 && filteredArticulos[selectedIndex]) {
      setDeleteStatus(null);
      setDeleteMessage('');
      setRelatedTables([]);
      setShowDeleteModal(true);
    }
  };

  // Abrir modal de cambiar c√≥digo
  const handleCambiarCodigoClick = () => {
    if (selectedIndex >= 0 && filteredArticulos[selectedIndex]) {
      const articulo = filteredArticulos[selectedIndex];
      setArticuloOriginal(articulo);
      setNuevoCodigo('');
      setCambiarCodigoResult(null);
      setCambioAplicado(false);
      setShowCambiarCodigoModal(true);
    }
  };

  // Abrir modal de trazabilidad por boleta
  const handleTrazabilidadClick = () => {
    if (selectedIndex >= 0 && filteredArticulos[selectedIndex]) {
      setShowTrazabilidadModal(true);
    }
  };

  // Cerrar modal de trazabilidad
  const handleCloseTrazabilidadModal = () => {
    setShowTrazabilidadModal(false);
  };

  // Aplicar cambio de c√≥digo
  const handleAplicarCambioCodigo = async () => {
    // Si el cambio ya se aplic√≥, solo cerrar el modal
    if (cambioAplicado) {
      handleCloseCambiarCodigoModal();
      return;
    }

    if (!nuevoCodigo || nuevoCodigo.trim() === '') {
      setCambiarCodigoResult({ error: 'Debe ingresar un nuevo c√≥digo' });
      return;
    }

    const articulo = articuloOriginal;
    if (!articulo) return;

    setCambiarCodigoLoading(true);
    setCambiarCodigoResult(null);

    try {
      const response = await fetch('http://localhost:4000/api/articulos/cambiar-codigo', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          codigoActual: articulo.codigo,
          codigoNuevo: nuevoCodigo.trim()
        })
      });

      const data = await response.json();

      if (response.ok) {
        setCambiarCodigoResult({
          success: true,
          message: data.message,
          tablasAfectadas: data.tablasAfectadas
        });
        setCambioAplicado(true);
        // Recargar la lista de art√≠culos
        await fetchArticulos();
      } else {
        setCambiarCodigoResult({ error: data.error });
      }
    } catch (error) {
      console.error('Error cambiando c√≥digo:', error);
      setCambiarCodigoResult({ error: 'Error al cambiar el c√≥digo del art√≠culo' });
    } finally {
      setCambiarCodigoLoading(false);
    }
  };

  // Abrir modal en modo nuevo
  const handleNuevoArticuloClick = () => {
    setEditMode(false);
    setArticuloEditar(null);
    setShowNuevoArticuloModal(true);
  } 

  // Abrir modal en modo edici√≥n
  const handleEditarArticuloClick = () => {
    if (selectedIndex >= 0 && filteredArticulos[selectedIndex]) {
      setEditMode(true);
      setArticuloEditar(filteredArticulos[selectedIndex]);
      setShowNuevoArticuloModal(true);
    }
  }

  const handleSaveNuevoArticulo = async (nuevoArticulo) => {
    try {
      console.log('Art√≠culo guardado:', nuevoArticulo);
      // Cerrar el modal
      setShowNuevoArticuloModal(false);

      // Recargar la lista de art√≠culos para mostrar el nuevo registro
      await fetchArticulos();

    } catch (error) {
      console.error('Error al recargar los art√≠culos:', error);
    }
  };

  const handleCloseNuevoArticuloModal = () => {
    setShowNuevoArticuloModal(false);
    setEditMode(false);
    setArticuloEditar(null);
  };

  const handleCloseCambiarCodigoModal = () => {
    setShowCambiarCodigoModal(false);
    setNuevoCodigo('');
    setCambiarCodigoResult(null);
    setCambioAplicado(false);
    setArticuloOriginal(null);
  };

  // Revisar relaciones del art√≠culo seleccionado
  const handleRevisarRelaciones = async () => {
    const articulo = filteredArticulos[selectedIndex];
    if (!articulo) return;

    setDeleteStatus('checking');
    setDeleteMessage('Revisando relaciones...');
    setRelatedTables([]);

    try {
      const codigo = articulo.codigo;

      // Verificar en materiales_proceso
      const mpResponse = await fetch(`http://localhost:4000/api/materiales_proceso/exists/${codigo}`);
      const mpData = await mpResponse.json();
      const mpExists = mpData.exists;

      // Verificar en transa_ar
      const taResponse = await fetch(`http://localhost:4000/api/transa_ar/exists/${codigo}`);
      const taData = await taResponse.json();
      const taExists = taData.exists;

      const foundTables = [];
      if (mpExists) foundTables.push('materiales_proceso');
      if (taExists) foundTables.push('transa_ar');

      setRelatedTables(foundTables);

      if (foundTables.length > 0) {
        setDeleteStatus('denied');
        setDeleteMessage(`ELIMINACI√ìN DENEGADA: El art√≠culo est√° siendo usado en ${foundTables.join(' y ')}.`);
      } else {
        setDeleteStatus('allowed');
        setDeleteMessage('Eliminaci√≥n Permitida: No se encontraron dependencias.');
      }
    } catch (error) {
      console.error('Error revisando relaciones:', error);
      setDeleteStatus('denied');
      setDeleteMessage('Error al revisar relaciones. Intente nuevamente.');
    }
  };

  // Eliminar el art√≠culo si est√° permitido
  const handleEliminarArticulo = async () => {
    const articulo = filteredArticulos[selectedIndex];
    if (!articulo || deleteStatus !== 'allowed') return;

    try {
      const codigo = articulo.codigo;
      const deletedTables = [];

      // Eliminar de articulos_x_cliente (todos los registros para este c√≥digo)
      const axcResponse = await fetch(`http://localhost:4000/api/articulos_x_cliente/${codigo}`, {
        method: 'DELETE'
      });
      if (axcResponse.ok) {
        const axcData = await axcResponse.json();
        if (axcData.affectedRows > 0) {
          deletedTables.push(`articulos_x_cliente (${axcData.affectedRows} registros)`);
        } else {
          deletedTables.push(`articulos_x_cliente (0 registros)`);
        }
      }

      // Eliminar de articulos
      const artResponse = await fetch(`http://localhost:4000/api/articulos/${codigo}`, {
        method: 'DELETE'
      });
      if (artResponse.ok) {
        const artData = await artResponse.json();
        if (artData.affectedRows > 0) {
          deletedTables.push(`articulos (${artData.affectedRows} registro)`);
        } else {
          deletedTables.push(`articulos (0 registros)`);
        }
      }

      // Recargar lista
      await fetchArticulos();

      setDeleteMessage(`Eliminaci√≥n completada. Tablas afectadas: ${deletedTables.join(', ')}`);
      setDeleteStatus('completed');

    } catch (error) {
      console.error('Error eliminando art√≠culo:', error);
      setDeleteMessage('Error al eliminar el art√≠culo.');
      setDeleteStatus('error');
    }
  };

  const handleCloseDeleteModal = () => {
    setShowDeleteModal(false);
    setDeleteStatus(null);
    setDeleteMessage('');
    setRelatedTables([]);
  };

  const handleExportToExcel = () => {
    // Validar que filteredArticulos sea un array antes de exportar
    if (!Array.isArray(filteredArticulos) || filteredArticulos.length === 0) {
      console.warn('No hay art√≠culos para exportar');
      return;
    }

    // Preparar los datos para exportar
    const dataToExport = filteredArticulos.map(articulo => ({
      'C√≥digo': articulo?.codigo || '',
      'Descripci√≥n': articulo?.descri || '',
      'Unidad': articulo?.unidad || '',
      'Familia': articulo?.familia || '',
      'Categor√≠a': articulo?.categoria || '',
      'Tipo de Certificado': articulo?.tipo_cert || '',
      'Tipo de Residuo': articulo?.tipo_res || ''
    }));

    // Crear el libro de trabajo
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(dataToExport);

    // Ajustar el ancho de las columnas
    const colWidths = [
      { wch: 15 }, // C√≥digo
      { wch: 35 }, // Descripci√≥n (reducida ~30%)
      { wch: 10 }, // Unidad
      { wch: 15 }, // Familia
      { wch: 15 }, // Categor√≠a
      { wch: 18 }, // Tipo de Certificado
      { wch: 18 }  // Tipo de Residuo
    ];
    ws['!cols'] = colWidths;

    // Agregar la hoja al libro
    XLSX.utils.book_append_sheet(wb, ws, 'Art√≠culos');

    // Generar el archivo y descargarlo
    const fileName = `articulos_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);

    // Cerrar el modal
    setShowExportModal(false);
  };

  const handleCloseExportModal = () => {
    setShowExportModal(false);
  };

  if (!isOpen) return null;

  return (
    <div className="lista-articulos-modal-overlay">
      <div id="lista-articulos-modal-root" className="lista-articulos-modal">
        <div className="lista-articulos-modal-header">
          <h2 className="lista-articulos-modal-title">Lista de Art√≠culos</h2>
          <button className="lista-articulos-modal-close" onClick={onClose}>
            ‚úï
          </button>
        </div>
        <div className="lista-articulos-modal-body">
          <div className="search-container">
            <input
              type="text"
              placeholder="Buscar por c√≥digo o descripci√≥n..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="search-input"
            />
          </div>
          <div className="content-wrapper">
            <div className="articulos-table-container">
              {loading && <p>Cargando art√≠culos...</p>}
              {error && <p className="error">Error: {error}</p>}
              {!loading && !error && (
                <>
                  <table className="articulos-table" ref={tableRef}>
                    <thead className="articulos-table-header">
                      <tr className="filter-row">
                        <th key="filter-codigo" className="filter-col-codigo"></th>
                        <th key="filter-descripcion" className="filter-col-descripcion"></th>
                        <th key="filter-unidad" className="filter-col-unidad">
                          <select
                            value={selectedUnidad}
                            onChange={(e) => setSelectedUnidad(e.target.value)}
                            className="column-filter-select"
                          >
                            <option value="">Todas</option>
                            {unidades.map(unidad => (
                              <option key={unidad.nombreu} value={unidad.nombreu}>
                                {unidad.nombreu}
                              </option>
                            ))}
                          </select>
                        </th>
                        <th key="filter-familia" className="filter-col-familia">
                          <select
                            value={selectedFamilia}
                            onChange={(e) => setSelectedFamilia(e.target.value)}
                            className="column-filter-select"
                          >
                            <option value="">Todas</option>
                            {familias.map(fam => (
                              <option key={fam.nombref} value={fam.nombref}>
                                {fam.nombref}
                              </option>
                            ))}
                          </select>
                        </th>
                        <th key="filter-categoria" className="filter-col-categoria"></th>
                        <th key="filter-tipo-cert" className="filter-col-tipo-cert"></th>
                        <th key="filter-tipo-res" className="filter-col-tipo-res"></th>
                      </tr>
                      <tr className="header-row">
                        <th key="header-codigo" className="header-codigo">C√≥digo</th>
                        <th key="header-descripcion" className="header-descripcion">Descripci√≥n</th>
                        <th key="header-unidad" className="header-unidad">Unidad</th>
                        <th key="header-familia" className="header-familia">Familia</th>
                        <th key="header-categoria" className="header-categoria">Categor√≠a</th>
                        <th key="header-tipo-cert" className="header-tipo-cert">Tipo de Certificado</th>
                        <th key="header-tipo-res" className="header-tipo-res">Tipo de Residuo</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Array.isArray(filteredArticulos) ? filteredArticulos.map((articulo, index) => (
                        <tr
                          key={articulo?.codigo || index}
                          data-index={index}
                          className={selectedIndex === index ? 'selected' : ''}
                          onClick={() => handleRowClick(index)}
                        >
                          <td>{articulo?.codigo || ''}</td>
                          <td>{articulo?.descri || ''}</td>
                          <td>{articulo?.unidad || ''}</td>
                          <td>{articulo?.familia || ''}</td>
                          <td>{articulo?.categoria || ''}</td>
                          <td>{articulo?.tipo_cert || ''}</td>
                          <td>{articulo?.tipo_res || ''}</td>
                        </tr>
                      )) : (
                        <tr>
                          <td colSpan="7" style={{ textAlign: 'center', padding: '20px' }}>
                            No hay art√≠culos disponibles
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                  {filteredArticulos.length === 0 && <p>No hay art√≠culos para mostrar.</p>}
                </>
              )}
            </div>
            <div className="action-buttons">
              <button className="action-btn nuevo" onClick={handleNuevoArticuloClick}>
                ‚ûï Nuevo
              </button>
              <button
                className="action-btn editar"
                onClick={handleEditarArticuloClick}
                disabled={selectedIndex < 0 || !filteredArticulos[selectedIndex]}
                title={selectedIndex < 0 || !filteredArticulos[selectedIndex] ? 'Seleccione un art√≠culo para editar' : 'Editar art√≠culo'}
              >
                ‚úèÔ∏è Editar
              </button>
              <button className="action-btn exportar" onClick={handleExportClick}>
                üì§ Exportar
              </button>
              <button 
                className="action-btn eliminar" 
                onClick={handleEliminarClick}
                disabled={selectedIndex < 0 || !filteredArticulos[selectedIndex]}
                title={selectedIndex < 0 || !filteredArticulos[selectedIndex] ? 'Seleccione un art√≠culo para eliminar' : 'Eliminar art√≠culo'}
              >
                üóëÔ∏è Eliminar
              </button>
              <button 
                className="action-btn cambiar-codigo" 
                onClick={handleCambiarCodigoClick}
                disabled={selectedIndex < 0 || !filteredArticulos[selectedIndex]}
                title={selectedIndex < 0 || !filteredArticulos[selectedIndex] ? 'Seleccione un art√≠culo para cambiar c√≥digo' : 'Cambiar C√≥digo de Art√≠culo'}
              >
                üîÑ Cambiar C√≥digo de Art√≠culo
              </button>
              <button 
                className="action-btn trazabilidad" 
                onClick={handleTrazabilidadClick}
                disabled={selectedIndex < 0 || !filteredArticulos[selectedIndex]}
                title={selectedIndex < 0 || !filteredArticulos[selectedIndex] ? 'Seleccione un art√≠culo para ver trazabilidad' : 'Ver Trazabilidad por Boleta'}
              >
                üìä Trazabilidad
              </button>
              <button className="action-btn actualizar" onClick={fetchArticulos}>
                üîÑ Actualizar
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Modal de Exportaci√≥n */}
      {showExportModal && (
        <div className="export-modal-overlay">
          <div className="export-modal">
            <div className="export-modal-header">
              <h3>Exportar Art√≠culos</h3>
            </div>
            <div className="export-modal-body">
              <p>¬øDesea exportar los art√≠culos filtrados a un archivo Excel?</p>
              <div className="export-info">
                <strong>Registros a exportar:</strong> {filteredArticulos.length}
              </div>
            </div>
            <div className="export-modal-footer">
              <button className="export-btn export-excel" onClick={handleExportToExcel}>
                üìä Exportar a Excel
              </button>
              <div className="export-modal-actions">
                <button className="export-btn export-cancel" onClick={handleCloseExportModal}>
                  ‚ùå SALIR
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal de Eliminar Art√≠culo */}
      {showDeleteModal && (
        <div className="delete-modal-overlay">
          <div className="delete-modal">
            <div className="delete-modal-header">
              <h3>Eliminar Art√≠culo</h3>
            </div>
            <div className="delete-modal-body">
              {filteredArticulos[selectedIndex] && (
                <div className="delete-article-info">
                  <p><strong>C√≥digo:</strong> {filteredArticulos[selectedIndex].codigo}</p>
                  <p><strong>Descripci√≥n:</strong> {filteredArticulos[selectedIndex].descri || filteredArticulos[selectedIndex].descripcion}</p>
                  <p><strong>Unidad:</strong> {filteredArticulos[selectedIndex].unidad}</p>
                </div>
              )}
              <div className="delete-status">
                <p className={`delete-message ${deleteStatus}`}>
                  {deleteMessage}
                </p>
                {relatedTables.length > 0 && (
                  <div className="related-tables">
                    <strong>Tablas relacionadas:</strong>
                    <ul>
                      {relatedTables.map(table => (
                        <li key={table}>{table}</li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            </div>
            <div className="delete-modal-footer">
              {deleteStatus === null && (
                <button 
                  className="delete-btn check-relations" 
                  onClick={handleRevisarRelaciones}
                >
                  üîç Revisar Relaciones
                </button>
              )}
              {deleteStatus === 'allowed' && (
                <button 
                  className="delete-btn confirm-delete" 
                  onClick={handleEliminarArticulo}
                >
                  üóëÔ∏è ELIMINAR
                </button>
              )}
              {(deleteStatus === 'completed' || deleteStatus === 'error') && (
                <button 
                  className="delete-btn close" 
                  onClick={handleCloseDeleteModal}
                >
                  ‚úÖ CERRAR
                </button>
              )}
              {deleteStatus !== 'completed' && deleteStatus !== 'error' && (
                <button 
                  className="delete-btn cancel" 
                  onClick={handleCloseDeleteModal}
                >
                  ‚ùå CANCELAR
                </button>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Modal de Nuevo/Editar Art√≠culo */}
      {showNuevoArticuloModal && (
        <NuevoArticuloModal
          isOpen={showNuevoArticuloModal}
          onClose={handleCloseNuevoArticuloModal}
          onSave={handleSaveNuevoArticulo}
          editMode={editMode}
          articuloEditar={articuloEditar}
        />
      )}

      {/* Modal de Cambiar C√≥digo */}
      {showCambiarCodigoModal && (
        <div className="cambiar-codigo-modal-overlay">
          <div className="cambiar-codigo-modal">
            <div className="cambiar-codigo-modal-header">
              <h3>Cambiar C√≥digo de Art√≠culo</h3>
            </div>
            <div className="cambiar-codigo-modal-body">
              {articuloOriginal && (
                <div className="cambiar-codigo-article-info">
                  <p><strong>C√≥digo actual:</strong> {articuloOriginal.codigo}</p>
                  <p><strong>Descripci√≥n:</strong> {articuloOriginal.descri || articuloOriginal.descripcion}</p>
                  <p><strong>Unidad:</strong> {articuloOriginal.unidad}</p>
                </div>
              )}
              <div className="cambiar-codigo-form">
                <label htmlFor="nuevo-codigo-articulo">Nuevo C√≥digo:</label>
                <input
                  id="nuevo-codigo-articulo"
                  type="text"
                  placeholder="Ingrese el nuevo c√≥digo"
                  className="cambiar-codigo-input"
                  value={nuevoCodigo}
                  onChange={(e) => setNuevoCodigo(e.target.value)}
                  disabled={cambiarCodigoLoading || cambioAplicado}
                />
              </div>
              {cambiarCodigoResult && (
                <div className={`cambiar-codigo-result ${cambiarCodigoResult.error ? 'error' : 'success'}`}>
                  {cambiarCodigoResult.error ? (
                    <p>‚ùå {cambiarCodigoResult.error}</p>
                  ) : (
                    <div>
                      <p>‚úÖ {cambiarCodigoResult.message}</p>
                      {cambiarCodigoResult.tablasAfectadas && cambiarCodigoResult.tablasAfectadas.length > 0 && (
                        <div className="tablas-afectadas">
                          <strong>Tablas modificadas:</strong>
                          <ul>
                            {cambiarCodigoResult.tablasAfectadas.map((tabla, index) => (
                              <li key={index}>{tabla}</li>
                            ))}
                          </ul>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}
            </div>
            <div className="cambiar-codigo-modal-footer">
              <button 
                className="cambiar-codigo-btn apply"
                onClick={handleAplicarCambioCodigo}
                disabled={cambiarCodigoLoading}
              >
                {cambiarCodigoLoading ? '‚è≥ Aplicando...' : cambioAplicado ? '‚úÖ Cerrar' : '‚úÖ Aplicar'}
              </button>
              {!cambioAplicado && (
                <button 
                  className="cambiar-codigo-btn cancel" 
                  onClick={handleCloseCambiarCodigoModal}
                  disabled={cambiarCodigoLoading}
                >
                  ‚ùå Cancelar
                </button>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Modal de Trazabilidad por Boleta */}
      <ArticulosXBoletaModal
        isOpen={showTrazabilidadModal}
        onClose={handleCloseTrazabilidadModal}
        articuloSeleccionado={selectedIndex >= 0 ? filteredArticulos[selectedIndex] : null}
      />
    </div>
  );
};

export default ListaArticulosModal;
